# WebServer

写的http服务器，不够完善，继续修改。

## 编译环境

系统：Ubuntu20.04

工具链：g++ 9.4.0；gdb 9.2；make 4.2.1；cmake 3.16.3

目录结构：

| include | src | conf | log | htdocs |
| ---- | ---- | ---- | ---- | ---- |
| 头文件 | 源文件 | 配置文件 | 日志文件 | 前端静态界面 |

## 构建方法

```shell
mkdir build
cd build
cmake ../
make
```

### 注意点

errno是线程安全的（thread_local，不同线程有不同的errno）, 可以在多线程中使用, POSIX线程将他定义成了宏。具体可以参见`man errno`。

## WebServer总体流程

* 收到消息请求之后，将所有请求内容读取出来。封装成一个request对象。

* 解析request对象，最终处理，返回一个response对象。

* 将response对象发送回去。

### 日志模块

日志模块，实现日志功能。

已有功能：

* 日志分级。
* 自定义日志格式。（时间戳，线程ID，文件，行号，日志级别）
* 自定义输出位置。
* 支持流式日志。

工作流程：

1. 初始化LogFormatter，LogAppender, Logger。

2. 其中LogFormatter和LogEvent会完成日志格式的解析。

3. 通过宏定义提供流式风格和格式化风格的日志接口。每次写日志时，通过宏自动生成对应的日志事件LogEvent，通过LogEvent和对应Logger生成一个LogEventWrap对象。

4. 宏执行结束后，LogEventWrap对象析构，在析构函数里调用`Logger`的log方法将日志事件进行输出(打印)。

主要的几个类:

#### LogEvent

把写日志当作一个事件，记录日志现场信息。目前包括日志内容
，日志器名称，日志级别，文件名和行号，程序运行时间，线程ID，UTC时间戳，线程名称等信息。

#### LogFormatter

日志格式器，用于格式化一个日志事件，将其转化成一串字符串。

#### LogAppender

日志输出器，用于输出一个日志事件。这是一个虚类，目前只有两个具体实现，比如往输出到cmd的StdoutLogAppender，以及输出到文件的FileLogAppender。

#### Logger

日志器，用于输出日志。这个类是**直接与用户进行交互的类**，提供一些方法用于输出日志事件。

#### LogManager

日志器管理类，单例模式，用于统一管理全部的日志器，提供getLogger()方法用于创建/获取日志器。内部维护一个名称到日志器的map，当获取的日志器存在时，直接返回对应的日志器指针，否则创建对应的日志器并返回。

### 配置模块

简单来说，就是服务器启动时读取相应配置文件。按照配置文件的设置启动，初始化。

配置包含：

1. 名称，对应一个字符串，必须唯一，不能与其他配置项产生冲突。

2. 类型，可以是基本类型，但也应该支持复杂类型和自定义类型。

3. 值。配置对应的值，通常还会有默认值。

4. 配置变更通知，一旦用户更新了配置值，那么应该通知所有使用了这项配置的代码，以便于进行一些具体的操作，比如重新打开文件，重新起监听端口等。也就是**支持动态配置**。

5. 校验方法，更新配置时会调用校验方法进行校验，以保证用户不会给配置项设置一个非法的值。

#### 约定大于配置

**约定大于配置**的思想？

### request解析器

专门用来解析http请求。

### 执行器

处理http请求，并返回结果。线程池处理，异步返回结果。

## 改进点

1. 线程池有时间需要重写，可以考虑如何实现动态线程池，如果异步获取返回值。

2. 配置系统需要重写，现在这个只是在简单的读写文件而已。

3. 日志系统再研究研究。
