# WebServer（debuging）

编译环境：CentOS7.7、g++4.8.5、gdb 7.9、cmake2.8.12.2、make3.82

准备实现的功能如下：

* 使用了epoll边沿触发 + EPOLLONESHOT + 非阻塞IO(Server socket和Client sockete都是非阻塞的)
* 使用了一个固定线程数的线程池(省去了每次都要创建和销毁线程的开销)
* 实现了一个任务队列，由条件变量触发通知新任务的到来
* 实现了一个小根堆的定时器及时剔除超时请求，使用了STL的优先队列来管理定时器
* 解析了HTTP的get、post请求，支持长短连接
* mime设计为单例模式
* 线程的工作分配为：
  * 主线程负责等待epoll中的事件，并把到来的事件放进任务队列，在每次循环的结束剔除超时请求和被置为删除的时间结点
  * 工作线程阻塞在条件变量的等待中，新任务到来后，某一工作线程会被唤醒，执行具体的IO操作和计算任务，如果需要继续监听，会添加到epoll中  

* 锁的使用有两处：
  * 第一处是任务队列的添加和取操作，都需要加锁，并配合条件变量，跨越了多个线程。
  * 第二处是定时器结点的添加和删除，需要加锁，主线程和工作线程都要操作定时器队列。
  
  碰到的错误：
  EAGAIN-（一般用于非阻塞的系统调用）
  
  非阻塞的系统调用，由于资源限制/不满足条件，导致返回值为EAGAIN
  
  在Linux环境下开发经常会碰到很多错误(设置errno)，其中EAGAIN是其中比较常见的一个错误(比如用在非阻塞操作中)。
  
  如：首先是把套接字设置为异步的了，然后在使用write发送数据时采取的方式是循环发送大量的数据；由于是异步的，write\send将要发送的数据提交到发送缓冲区后是立即返回的，并不需要对端确认数据已接收。在这种情况下是很有可能出现发送缓冲区被填满，导致write\send无法再向缓冲区提交要发送的数据。因此就产生了Resource temporarily unavailable的错误（资源暂时不可用），EAGAIN 的意思也很明显，就是要你再次尝试。
  
  从字面上来看，是提示再试一次。这个错误经常出现在当应用程序进行一些非阻塞(non-blocking)操作(对文件或socket)的时候。